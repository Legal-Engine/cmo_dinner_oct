<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Amy - Legal Engine Dinner Agent</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root{
        --navy:#0b1f3b;
        --ink:#0f172a;
        --muted:#64748b;
        --bg:#f4f6fb;
        --card:#ffffff;
        --accent:#3b82f6;
        --border:#e5e7eb;
      }
      html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:-apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
      .wrap{max-width:960px;margin:0 auto;padding:24px}
      .header{background:var(--navy);border-bottom:1px solid #0a1a32}
      .header .inner{max-width:960px;margin:0 auto;padding:12px 24px;text-align:center}
      .logo{max-width:200px;height:auto;display:inline-block;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.10);background:#fff}
      h1{font-size:26px;margin:16px 0 6px;text-align:center;color:var(--navy)}
      p.lead{margin:0 auto 14px;text-align:center;max-width:720px;color:#334155}
      .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 20px rgba(15,23,42,.06)}
      .section{padding:18px 20px}
      .muted{color:var(--muted);font-size:14px}
      .fields{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .field{display:flex;flex-direction:column;gap:6px;text-align:left}
      label{font-size:12px;color:#334155}
      input[type="text"]{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:#0f172a}
      .cta{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:16px}
      .btn{display:inline-block;background:var(--accent);color:#fff;text-decoration:none;padding:12px 16px;border-radius:10px;font-weight:700}
      .btn.secondary{background:#e0ecff;color:#0b1f3b}
      .divider{height:1px;background:var(--border);margin:16px 0}
      .center{text-align:center}

      /* Powered by block (now inside the single card) */
      .partner{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-top:12px}
      .partner small{color:var(--muted)}
      .le-logo{height:28px;max-width:180px;object-fit:contain;display:block}

      /* Responsive iframe container */
      .iframe-responsive {
        position: relative;
        width: 100%;
        padding-bottom: 65vh;
        height: 0;
        overflow: visible;
        margin-bottom: 18px;
      }
      .iframe-responsive iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
        min-height: 400px;
        background: #fff;
      }
      @media (max-width: 600px) {
        .iframe-responsive {
          padding-bottom: 80dvh;
          min-height: 80dvh;
          height: auto;
        }
        .iframe-responsive iframe {
          min-height: 80dvh;
          position: static;
          height: 80dvh;
        }
      }

      @media (max-width:800px){
        .fields{grid-template-columns:1fr}
      }
      @media (prefers-color-scheme: dark){
        :root{ --bg:#0b1329; --card:#121a34; --ink:#e8eef7; --border:#2a3865; --muted:#a9b5d2 }
        .logo{background:transparent; box-shadow:none}
        h1{color:#cfe0ff}
        input[type="text"]{background:#0f1730;border-color:#2a3865;color:#e8eef7}
        .btn.secondary{background:#203566;color:#e8eef7}
        .partner{background:#0f1730;border-color:#2a3865}
      }
    </style>
  </head>
  <body>


    <div class="wrap">
  <h1>Legal Engine BD Ops Dinner</h1>
  <p class="lead"></p>

      <!-- SINGLE CARD: identity + summit link + powered by + agent widget -->
      <div class="card section" style="margin-top:10px">


        <!-- Editable (pre-populated) fields -->
        <!-- Editable (pre-populated) fields moved below iframe -->

        <div class="cta">
          <!-- Summit website button removed -->
        </div>

        <!-- Powered by Legal Engine section removed -->

  <!-- Divider removed -->

        <!-- Agent widget moved into this same card -->
        <p class="muted center" id="who" style="margin:0 0 10px"></p>

        <elevenlabs-convai agent-id="agent_0301k5x11j1kfdkthd2afh0nrcba"></elevenlabs-convai>
        <script>
          (function () {
            var qs = new URLSearchParams(window.location.search);
            function getQ(keys){
              if (Array.isArray(keys)) { for (var i=0;i<keys.length;i++){ var v = qs.get(keys[i]); if(v) return v; } return ""; }
              return qs.get(keys) || "";
            }
            function s(v){ return String(v || "").replace(/[<>]/g, ""); }
            function splitName(full){
              full = (full || "").trim();
              if (!full) return { first:"", last:"" };
              var parts = full.split(/\s+/);
              var first = parts.shift() || "";
              var last  = parts.join(" ");
              return { first:first, last:last };
            }
            var fullName = s(getQ(["name","full_name","fullname"]));
            var first    = s(getQ(["first","firstname","first_name","fname"]));
            var last     = s(getQ(["last","lastname","last_name","lname"]));
            if ((!first || !last) && fullName) {
              var parts = splitName(fullName);
              first = first || parts.first;
              last  = last  || parts.last;
            }
            var normalizedName = (fullName || [first, last].filter(Boolean).join(" ")).trim();
            var agent = document.querySelector('elevenlabs-convai[agent-id]');
            if (agent) {
              var dynVars = {
                first_name: first,
                last_name: last,
                full_name: normalizedName,
                utm_source: s(getQ("utm_source")),
                utm_medium: s(getQ("utm_medium")),
                utm_campaign: s(getQ("utm_campaign")),
                utm_content: s(getQ("utm_content")),
                company: s(getQ(["company","organisation","organization"])),
                email: s(getQ(["email","e","mail"])),
                role: s(getQ(["role","job_title","title","position"]))
              };
              agent.setAttribute("dynamic-variables", JSON.stringify(dynVars));
              if (first) {
                agent.setAttribute(
                  "override-first-message",
                  "Hi " + first + ", Iâ€™m Amy from the Legal Engine team. Lovely to meet you, how are you doing today?"
                );
              }
            }
          })();
        </script>

          <!-- Office Forms iframe embedded below main boxes -->
          <div class="iframe-responsive" id="iframe-container">
            <button id="show-iframe-btn" style="display:none;width:100%;padding:18px 0;font-size:18px;font-weight:700;background:#3b82f6;color:#fff;border:none;border-radius:10px;">Tap to open RSVP form</button>
            <iframe 
              src="https://forms.office.com/Pages/ResponsePage.aspx?id=j8bV-mnRc0O-11UkO9mce83JcY9Tmj9Nk2Be37kh_XdUNTBMOUlZOVQ3OEJOSEc2TlEyUEZUNkVBSS4u&embed=true"
              frameborder="0"
              allow="microphone; camera; autoplay; clipboard-read; clipboard-write; fullscreen"
              allowfullscreen webkitallowfullscreen mozallowfullscreen msallowfullscreen
              id="le-form-iframe"
              title="Legal Engine Dinner RSVP Form"
              style="display:block;"
            ></iframe>
            <div id="iframe-fallback" style="display:none; text-align:center; margin-top:12px;">
              <p style="color:#e11d48; font-weight:600;">If the form does not appear, <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=j8bV-mnRc0O-11UkO9mce83JcY9Tmj9Nk2Be37kh_XdUNTBMOUlZOVQ3OEJOSEc2TlEyUEZUNkVBSS4u" target="_blank" rel="noopener" style="color:#2563eb; text-decoration:underline;">tap here to open the RSVP form in a new tab</a>.</p>
            </div>
          </div>
    <script>
      // Mobile: require tap to reveal iframe, allow/fallback logic
      document.addEventListener('DOMContentLoaded', function() {
        var isMobile = /iPhone|iPad|iPod|Android|Mobile|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        var iframe = document.getElementById('le-form-iframe');
        var fallback = document.getElementById('iframe-fallback');
        var btn = document.getElementById('show-iframe-btn');
        var container = document.getElementById('iframe-container');
        var loaded = false;
        if (isMobile && iframe && btn) {
          iframe.style.display = 'none';
          btn.style.display = 'block';
          btn.addEventListener('click', function() {
            btn.style.display = 'none';
            iframe.style.display = 'block';
            // Try to focus the iframe for user gesture
            setTimeout(function(){
              try { iframe.contentWindow.focus(); } catch(e){}
            }, 100);
          });
        }
        // Fallback if iframe fails to load
        if (iframe) {
          setTimeout(function() {
            if (!loaded) fallback.style.display = 'block';
          }, 3500);
          iframe.onload = function() {
            loaded = true;
            fallback.style.display = 'none';
          };
        }
      });
    </script>

          <div class="fields" style="margin-top:24px">
            <div class="field">
              <label for="f_full_name">Full name</label>
              <input id="f_full_name" type="text" placeholder="(not provided)">
            </div>
            <div class="field">
              <label for="f_company">Company</label>
              <input id="f_company" type="text" placeholder="(not provided)">
            </div>
          </div>
          </div>
      </div>
    </div>

    <script>
      (function () {
        // ------- Helpers
        var qs = new URLSearchParams(window.location.search);
        function getQ(keys){
          if (Array.isArray(keys)) { for (var i=0;i<keys.length;i++){ var v = qs.get(keys[i]); if(v) return v; } return ""; }
          return qs.get(keys) || "";
        }
        function s(v){ return String(v || "").replace(/[<>]/g, ""); }
        function splitName(full){
          full = (full || "").trim();
          if (!full) return { first:"", last:"" };
          var parts = full.split(/\s+/);
          var first = parts.shift() || "";
          var last  = parts.join(" ");
          return { first:first, last:last };
        }
        function uuid(){ return 'cid_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36); }

        // ------- Read identity + UTM params
        var fullName = s(getQ(["name","full_name","fullname"]));
        var first    = s(getQ(["first","firstname","first_name","fname"]));
        var last     = s(getQ(["last","lastname","last_name","lname"]));
        var role     = s(getQ(["role","job_title","title","position"]));
        var company  = s(getQ(["company","organisation","organization"]));
        var email    = s(getQ(["email","e","mail"]));

        if ((!first || !last) && fullName) {
          var parts = splitName(fullName);
          first = first || parts.first;
          last  = last  || parts.last;
        }
        var normalizedName = (fullName || [first, last].filter(Boolean).join(" ")).trim();

        var utm_source   = s(getQ(["utm_source","source"]));
        var utm_medium   = s(getQ(["utm_medium","medium"]));
        var utm_campaign = s(getQ(["utm_campaign","campaign"]));
        var utm_term     = s(getQ(["utm_term","term"]));
        var utm_content  = s(getQ(["utm_content","content"]));

        var client_id = s(getQ("client_id")) || (localStorage.getItem("psmg_client_id") || uuid());
        try { localStorage.setItem("psmg_client_id", client_id); } catch(e){}

        // ------- Prefill EDITABLE boxes (user can change them)
        document.getElementById("f_full_name").value = normalizedName || "";
        document.getElementById("f_company").value   = company || "";
        document.getElementById("f_email").value     = email || "";
        document.getElementById("f_role").value      = role || "";

        // ------- Build dynamic variables from CURRENT inputs (so edits flow through)
        function currentDyn(){
          var nameNow    = document.getElementById("f_full_name").value.trim();
          var roleNow    = document.getElementById("f_role").value.trim();
          var companyNow = document.getElementById("f_company").value.trim();
          var emailNow   = document.getElementById("f_email").value.trim();
          var parts = splitName(nameNow);
          return {
            first_name: parts.first || first || "",
            last_name:  parts.last  || last  || "",
            full_name:  nameNow || normalizedName || "",
            role:       roleNow || role || "",
            company:    companyNow || company || "",
            email:      emailNow || email || "",
            client_id:  client_id,
            utm_source:  utm_source || "",
            utm_medium:  utm_medium || "",
            utm_campaign:utm_campaign || "",
            utm_term:    utm_term || "",
            utm_content: utm_content || ""
          };
        }

        // ------- Greeting logic
        var hasIdentity = !!(normalizedName || company);
        var defaultGreeting =
          "Hi there. I'm Lottie, one of the Summit organisers here at PSMG. " +
          "We're super excited to have you on board this year. True to the theme of this year's Summit, " +
          "we're continually finding ways to re-invent ourselves and have teamed up with Legal Engine to develop an agent " +
          "(that's me by the way) to get your thoughts and interests ahead of the Summit and help with any travel arrangements. " +
          "May I please confirm who I'm speaking with?";
        var personalisedGreeting =
          "Hi " + (first ? first : "there") +
          (company ? " from " + company : "") +
          ". I'm Lottie, one of the Summit organisers here at PSMG. We're super excited to have you on board this year. " +
          "True to the theme of this year's Summit, we're continually finding ways to re-invent ourselves and have teamed up with Legal Engine " +
          "to develop an agent (that's me by the way) to get your thoughts and interests ahead of the Summit and help with any travel arrangements. " +
          "Shall we get started?";
        var firstMessage = hasIdentity ? personalisedGreeting : defaultGreeting;

        var widget = document.getElementById("psmgAgent");
        if (widget) {
          widget.setAttribute("dynamic-variables", JSON.stringify(currentDyn()));
          widget.setAttribute("override-first-message", firstMessage);
        }

        // Keep widget's dynamic variables fresh on any edit
        ["f_full_name","f_role","f_company","f_email"].forEach(function(id){
          var el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("input", function(){
            if (widget) widget.setAttribute("dynamic-variables", JSON.stringify(currentDyn()));
          });
        });

        // Optional: log to n8n (minimal)
        try {
          var payload = new URLSearchParams();
          payload.set("event","landing_context");
          payload.set("client_id", client_id);
          payload.set("first_name", first || "");
          payload.set("last_name",  last || "");
          payload.set("full_name",  normalizedName || "");
          payload.set("role",       role || "");
          payload.set("company",    company || "");
          payload.set("email",      email || "");
          payload.set("utm_source", utm_source);
          payload.set("utm_medium", utm_medium);
          payload.set("utm_campaign", utm_campaign);
          payload.set("utm_term",   utm_term);
          payload.set("utm_content",utm_content);
          payload.set("page_url",   location.href);
          fetch("https://leonard-dev.app.n8n.cloud/webhook/luke-pre-brief", {
            method:"POST",
            headers:{ "Content-Type":"application/x-www-form-urlencoded" },
            body: payload.toString()
          }).catch(function(){});
        } catch(e){}

        // Append current querystring to Legal Engine About links (UTMs follow)
        var qsString = window.location.search || "";
        var leA = document.getElementById("leLink");
        var leB = document.getElementById("leTextLink");
        if (leA) leA.href = "https://legalengine.co.uk/about-us" + qsString;
        if (leB) leB.href = "https://legalengine.co.uk/about-us" + qsString;
      })();
    </script>

  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
  </body>
</html>
